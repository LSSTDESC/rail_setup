name: Create new release

on: [push]

jobs:
  Make-Release:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0} # for conda, since otherwise default is sh

    steps:
      # setup
      - uses: actions/checkout@v6
      - uses: conda-incubator/setup-miniconda@v3.2.0
        with:
          conda-remove-defaults: true # not required, but avoids a warning
      - uses: docker/setup-buildx-action@v3.11.1

      # lockfiles
      - name: Create Lockfiles
        run: |
          conda install --channel conda-forge --yes -- conda-lock
          conda-lock lock --kind explicit \
            --platform linux-64 --platform osx-arm64 \
            --file conda-lock/environment.yml

      # docker image
      - name: Build the Docker Image
        run: |
          cp conda-*.lock Docker/
          cp install_rail.py Docker/
      - uses: docker/build-push-action@v6
        with:
          tags: desc-rail:${{github.ref_name}}
          outputs: type=docker,dest=desc-rail_${{github.ref_name}}.tar
          file: Docker/Dockerfile

      # checks
      - name: test docker image build
        run: docker image ls
      - name: test lockfiles
        run: ls
